#!/bin/bash

clear
echo "ðŸ› ï¸  Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ Ø¨Ø§ Rathole"
echo "--------------------------------------------------"

echo "1. Ù†ØµØ¨ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ø®Ø§Ø±Ø¬ÛŒ (Server)"
echo "2. Ù†ØµØ¨ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ø§ÛŒØ±Ø§Ù† (Client)"
echo "3. Ø®Ø±ÙˆØ¬"
read -p "Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ [1-3]: " OPTION

install_rathole() {
  echo "â¬‡ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Rathole..."
  wget https://github.com/rapiz1/rathole/releases/latest/download/rathole-x86_64-unknown-linux-gnu.tar.gz -O rathole.tar.gz
  tar -xzf rathole.tar.gz
  chmod +x rathole
  mv rathole /usr/local/bin/
  echo "âœ… Rathole Ù†ØµØ¨ Ø´Ø¯."
}

generate_server_config() {
  echo "ðŸ“¡ Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø³Ø±ÙˆØ±..."
  mkdir -p /etc/rathole
  cat > /etc/rathole/server.toml <<EOF
[server]
bind_addr = "0.0.0.0:4567"

[clients.iran]
password = "supersecure"

[clients.iran.ports.ssh]
listen = "0.0.0.0:2222"
remote = "127.0.0.1:22"
EOF
  echo "âœ… ÙØ§ÛŒÙ„ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø³Ø±ÙˆØ± Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯."
}

generate_client_config() {
  read -p "ðŸ”‘ IP Ø³Ø±ÙˆØ± Ø®Ø§Ø±Ø¬ÛŒ Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†: " SERVER_IP
  echo "ðŸ“¦ Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª..."
  mkdir -p /etc/rathole
  cat > /etc/rathole/client.toml <<EOF
[client]
server_addr = "${SERVER_IP}:4567"
default_token = "supersecure"

[services.ssh]
local = "127.0.0.1:22"
EOF
  echo "âœ… ÙØ§ÛŒÙ„ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯."
}

create_service() {
  ROLE=$1
  echo "âš™ï¸ Ø³Ø§Ø®Øª Ø³Ø±ÙˆÛŒØ³ systemd Ø¨Ø±Ø§ÛŒ $ROLE..."
  cat > /etc/systemd/system/rathole.service <<EOF
[Unit]
Description=Rathole tunnel service
After=network.target

[Service]
ExecStart=/usr/local/bin/rathole -c /etc/rathole/${ROLE}.toml
Restart=always

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reexec
  systemctl daemon-reload
  systemctl enable rathole
  systemctl start rathole
  echo "âœ… Ø³Ø±ÙˆÛŒØ³ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯ Ùˆ ÙØ¹Ø§Ù„ Ø´Ø¯."
}

case $OPTION in
  1)
    install_rathole
    generate_server_config
    create_service server
    ;;
  2)
    install_rathole
    generate_client_config
    create_service client
    ;;
  3)
    echo "ðŸ‘‹ Ø®Ø¯Ø§Ø­Ø§ÙØ¸!"
    exit 0
    ;;
  *)
    echo "âŒ Ú¯Ø²ÛŒÙ†Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±!"
    ;;
esac
