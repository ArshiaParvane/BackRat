cat > setup-mikrotik-chr.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

VM_NAME="mikrotik-chr"
CHR_VERSION="7.15.3"
RAM_MB=512
VCPUS=1
DISK_IMG="chr.qcow2"
EXTRA_DISK_GB=2
NETWORK_MODE="nat"

echo ">>> Installing dependencies..."
apt update && apt install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager unzip wget qemu-utils

echo ">>> Downloading CHR $CHR_VERSION ..."
wget -O chr.img.zip "https://download.mikrotik.com/routeros/$CHR_VERSION/chr-$CHR_VERSION.img.zip"
unzip -o chr.img.zip

echo ">>> Converting image..."
qemu-img convert -f raw -O qcow2 chr-$CHR_VERSION.img $DISK_IMG
qemu-img resize $DISK_IMG +${EXTRA_DISK_GB}G

echo ">>> Starting libvirtd..."
systemctl enable --now libvirtd

echo ">>> Creating VM..."
virt-install \
  --name "$VM_NAME" \
  --memory "$RAM_MB" \
  --vcpus "$VCPUS" \
  --disk path=$DISK_IMG,format=qcow2 \
  --import \
  --network network=default \
  --noautoconsole

echo ""
echo "âœ… MikroTik CHR installed!"
echo "To connect to console:"
echo "  sudo virsh console $VM_NAME"
echo ""
echo "Default login: admin (no password)"
EOF
chmod +x setup-mikrotik-chr.sh
./setup-mikrotik-chr.sh --nat
