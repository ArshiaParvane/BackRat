#!/bin/bash

# dynx.sh v1.0 - DNS Manager & Network Fix Tool by Pfcloud

# ฺฺฉ ฺฉุฑุฏู ูุฌูุฏ whiptail
if ! command -v whiptail &> /dev/null; then
  echo "ูุทูุงู ูุจู ุงุฌุฑุง whiptail ุฑู ูุตุจ ฺฉู:"
  echo "sudo apt update && sudo apt install -y whiptail"
  exit 1
fi

declare -A DNS_SERVERS=(
  ["Dynx"]="185.51.200.2 185.51.200.3"
  ["Shecan"]="178.22.122.100 185.51.200.2"
  ["MihanWebhost"]="185.55.226.26 185.55.226.27"
  ["Google"]="8.8.8.8 8.8.4.4"
  ["Cloudflare"]="1.1.1.1 1.0.0.1"
)

TMP_RESOLV="/tmp/resolv.conf.dyndns"

function set_dns_temp() {
  local dns1=$1
  local dns2=$2
  echo -e "nameserver $dns1\nnameserver $dns2" | sudo tee /etc/resolv.conf > /dev/null
}

function set_dns_systemd() {
  local dns1=$1
  local dns2=$2
  sudo mkdir -p /etc/systemd/resolved.conf.d
  echo -e "[Resolve]\nDNS=$dns1 $dns2\nFallbackDNS=8.8.8.8\nDNSOverTLS=no\n" | sudo tee /etc/systemd/resolved.conf.d/dynx.conf > /dev/null
  sudo systemctl restart systemd-resolved
}

function test_dns() {
  local dns=$1
  local domains=("github.com" "telegram.org" "google.com")
  local failed=0
  for d in "${domains[@]}"; do
    if ! dig @$dns $d +short | grep -qE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+'; then
      failed=1
      echo "โ $d resolve ูุดุฏ"
    else
      echo "โ $d resolve ุดุฏ"
    fi
  done
  return $failed
}

function restore_resolv() {
  sudo cp /etc/resolv.conf.backup /etc/resolv.conf 2>/dev/null && echo "โ ูุงู resolv.conf ุจุงุฒุงุจ ุดุฏ" || echo "โ๏ธ ุจฺฉุงูพ ููุฌูุฏ ูุณุช"
}

# Backup resolv.conf if not done
if [ ! -f /etc/resolv.conf.backup ]; then
  sudo cp /etc/resolv.conf /etc/resolv.conf.backup
fi

while true; do
  CHOICE=$(whiptail --title "dynx.sh - DNS Manager & Fix Tool" --menu "ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉูุฏ:" 15 60 6 \
    1 "ูุนุงูุณุงุฒ DNS Dynx" \
    2 "ูุนุงูุณุงุฒ DNS ุฏูุฎูุงู" \
    3 "ุชุณุช ุงุชุตุงู ุงูุชุฑูุช" \
    4 "ุจุงุฒฺฏุฑุฏุงู DNS ูพุดูุฑุถ" \
    5 "ุฎุฑูุฌ" 3>&1 1>&2 2>&3)

  case $CHOICE in
    1)
      echo -e "\nูุนุงูุณุงุฒ DNS Dynx..."
      set_dns_temp ${DNS_SERVERS["Dynx"]}
      if systemctl is-active systemd-resolved &>/dev/null; then
        set_dns_systemd ${DNS_SERVERS["Dynx"]}
      fi
      echo "ุฏุฑ ุญุงู ุชุณุช DNS..."
      test_dns 185.51.200.2
      read -p "ูโุฎูุงูุฏ ุชูุธู DNS ุฑุง ุฏุงุฆู ฺฉูุฏุ (y/n): " yn
      if [[ $yn == "y" ]]; then
        if systemctl is-active systemd-resolved &>/dev/null; then
          set_dns_systemd ${DNS_SERVERS["Dynx"]}
          echo "โ DNS Dynx ุจู ุตูุฑุช ุฏุงุฆู ูุนุงู ุดุฏ"
        else
          echo -e "nameserver ${DNS_SERVERS["Dynx"]}" | sudo tee /etc/resolv.conf > /dev/null
          echo "โ DNS Dynx ุฑู resolv.conf ุฐุฎุฑู ุดุฏ"
        fi
      fi
      ;;
    2)
      OPTIONS=""
      for key in "${!DNS_SERVERS[@]}"; do
        OPTIONS+="$key \"$key\" "
      done
      DNS_CHOICE=$(whiptail --title "ุงูุชุฎุงุจ DNS" --menu "ฺฉ DNS ุงูุชุฎุงุจ ฺฉูุฏ:" 15 60 5 $OPTIONS 3>&1 1>&2 2>&3)
      if [[ -n "$DNS_CHOICE" ]]; then
        echo -e "\nูุนุงูุณุงุฒ DNS $DNS_CHOICE..."
        set_dns_temp ${DNS_SERVERS[$DNS_CHOICE]}
        if systemctl is-active systemd-resolved &>/dev/null; then
          set_dns_systemd ${DNS_SERVERS[$DNS_CHOICE]}
        fi
        echo "ุฏุฑ ุญุงู ุชุณุช DNS..."
        test_dns $(echo ${DNS_SERVERS[$DNS_CHOICE]} | awk '{print $1}')
        read -p "ูโุฎูุงูุฏ ุชูุธู DNS ุฑุง ุฏุงุฆู ฺฉูุฏุ (y/n): " yn
        if [[ $yn == "y" ]]; then
          if systemctl is-active systemd-resolved &>/dev/null; then
            set_dns_systemd ${DNS_SERVERS[$DNS_CHOICE]}
            echo "โ DNS $DNS_CHOICE ุจู ุตูุฑุช ุฏุงุฆู ูุนุงู ุดุฏ"
          else
            echo -e "nameserver ${DNS_SERVERS[$DNS_CHOICE]}" | sudo tee /etc/resolv.conf > /dev/null
            echo "โ DNS $DNS_CHOICE ุฑู resolv.conf ุฐุฎุฑู ุดุฏ"
          fi
        fi
      else
        echo "ุงูุชุฎุงุจ DNS ูุบู ุดุฏ."
      fi
      ;;
    3)
      echo -e "\nุฏุฑ ุญุงู ุชุณุช ุงุชุตุงู ุงูุชุฑูุช..."
      ping -c 2 8.8.8.8 &> /dev/null && echo "โ ูพูฺฏ ูููู" || echo "โ ูพูฺฏ ูุงูููู"
      curl -s --max-time 5 https://google.com &> /dev/null && echo "โ ุงุชุตุงู HTTP/HTTPS ุจุฑูุฑุงุฑ ุงุณุช" || echo "โ ุงุชุตุงู HTTP/HTTPS ูุทุน ุงุณุช"
      ;;
    4)
      echo -e "\nุฏุฑ ุญุงู ุจุงุฒฺฏุฑุฏุงู DNS ูพุดูุฑุถ..."
      restore_resolv
      ;;
    5)
      echo "ุฎุฑูุฌ... ๐โโ๏ธ"
      exit 0
      ;;
    *)
      echo "ฺฏุฒูู ูุงูุนุชุจุฑ ุงุณุช."
      ;;
  esac

  read -p "ุจุฑุง ุงุฏุงูู Enter ุจุฒูุฏ..."
done
